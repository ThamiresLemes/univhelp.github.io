!function(l,d,r,h){"use strict";var c=d.lang||{},p=d.Twig||{},u={};l.widget("sitemaker.treeBuilder",{options:{ajaxUrl:"",loadSpeed:10,fields:{itemId:"item_id",itemTitle:"item_title",parentId:"parent_id"},listType:"ol",noNesting:".no-nest",nestedList:"#sortable",editForm:"#edit-form",noItems:"#no-items",addBtn:"#add-new",addBulkBtn:"#add-bulk",addBulkList:"#add_list",saveBtn:"#save",deleteSelBtn:"#delete-selected",rebuildBtn:"#rebuild-tree",selectAll:"#select-all",loading:"#loading",ajaxMessage:"#ajax-message",itemTemplate:"#item-template",actionClass:".item-action",selectItemClass:".select-item",iconSelectClass:".icon-select",dialogEdit:"",dialogConfirm:"#dialog-confirm",loaded:function(){},updated:function(){}},_create:function(){var a=this,s={},n={},t={};this.nestedList=this.element.addClass("tree-builder").find(this.options.nestedList).nestedSortable({disableNesting:this.options.noNesting,forcePlaceholderSize:!0,listType:this.options.listType,handle:"div",helper:"clone",items:"li",opacity:.6,placeholder:"placeholder",tabSize:25,tolerance:"pointer",toleranceElement:"> div",errorClass:this.options.ajaxMessage,update:function(){a.itemsChanged=!0,a.saveBtn.button("option","disabled")&&a.saveBtn.button("option","disabled",!1)}}),this.selectAllObj=this.element.find(this.options.selectAll).click(function(){a.nestedList.find(a.options.selectItemClass).prop("checked",this.checked),this.checked?a.deleteSelBtn.button("enable"):a.deleteSelBtn.button("disable")}),n[c.deleteChildNodes]=function(){var e=l("li#item-"+a.itemID);a._removeNode(e),l(this).dialog("close"),a._saveTree()},n[c.deleteNode]=function(){var e=l("li#item-"+a.itemID);e.children(a.options.listType).length&&e.children(a.options.listType).children("li").appendTo(e.parent(a.options.listType)),a._removeNode(e),l(this).dialog("close"),a._saveTree()},n[c.cancel]=function(){l(this).dialog("close")},s[c.saveNode]=function(){a._checkRequired()&&(a._submitForm(a.itemID),l(this).dialog("close"))},s[c.cancel]=function(){l(a.dialogID).dialog("close")},t[c.deleteNode]=function(){a.element.find(a.options.selectItemClass+":checked").parentsUntil("li").parent().each(function(){a._removeNode(l(this))}),a._saveTree(),l(this).dialog("close")};var e={autoOpen:!(t[c.cancel]=function(){l(this).dialog("close")}),modal:!0,width:"auto",show:"slide",hide:"slide"};l(this.options.dialogEdit).dialog(e),l(this.options.dialogConfirm).dialog(e),this.msgObj=this.element.find(this.options.ajaxMessage);var i=this.element.find(this.options.loading);l(r).ajaxStart(function(){i.fadeIn()}).ajaxStop(function(){i.fadeOut()}).ajaxComplete(function(e,t){t.responseJSON&&t.responseJSON.message&&a.showMessage(t.responseJSON.message)}).ajaxError(function(){a.showMessage(c.errorMessage)}),d.onbeforeunload=function(e){if(!0===a.itemsChanged)return(e=e||d.event)&&(e.returnValue=c.unsavedChanges),c.unsavedChanges};var o={};o["click"+this.options.selectItemClass]=function(){var e=this.element.find(this.options.selectItemClass+":checked").length;0<e?this.deleteSelBtn.button("enable"):this.deleteSelBtn.button("disable"),e===this.element.find(this.options.selectItemClass).length?this.selectAllObj.prop("checked",!0):this.selectAllObj.prop("checked",!1)},o["click.editable"]=function(e){this._makeEditable(l(e.target))},o["blur#inline-edit"]=function(e){this._processEditable(l(e.target))},o["submit#inline-form"]=function(e){e.preventDefault(),l(e.target).find("#inline-edit").trigger("blur")},o["click"+this.options.actionClass]=function(e){var t=l(e.currentTarget).data("action");switch(this.itemID=a._getItemId(l(e.currentTarget)),t){case"edit":this.dialogID=this.options.dialogEdit,this._populateForm(this.itemID,function(e){l(e).dialog({buttons:s}).dialog("option","title",c.editNode).dialog("open")});break;case"delete":var i=l.extend({},n);this.dialogID=this.options.dialogConfirm,l("#item-"+this.itemID).children(this.options.listType).children("li").length<1&&delete i[c.deleteChildNodes],l(this.dialogID).dialog({buttons:i}).dialog("open")}},this._on(this.document,o),this.addBtn=this.element.find(this.options.addBtn).button({icons:{primary:"ui-icon-plus"}}).click(function(e){e.preventDefault(),a.options.dialogEdit.length?(a.itemID=h,a.dialogID=a.options.dialogEdit,a.editForm.populate({}),l(a.dialogID).dialog({buttons:s}).dialog("option","title",c.addNode).dialog("open")):a.addItem()}),this.addBulkBtn=this.element.find(this.options.addBulkBtn).button({text:!1,icons:{primary:"ui-icon-triangle-1-s"}}).click(function(e){e.preventDefault();var t=l(e.currentTarget).toggleClass("dropped").blur(),i=t.parent().next(),s=i.width(),n=t.offset(),o=i.slideToggle().offset({top:n.top+t.height()+10,left:n.left-s/2+t.width()});if(!0===t.hasClass("dropped")){var d='<option value="0">'+c.none+"</option>";o.find("select").html(a._getOptions(a.nestedList,"",d)).next().val()}}),this.addBulkBtn.parent().buttonset().show().next().hide().find("#cancel").click(function(){a.addBulkBtn.trigger("click")}).next().click(function(e){var t=l(e.target).parentsUntil("form").parent(),i={add_list:u.getValue()};i[a.options.fields.parentId]=t.find("#parent_id").val(),u.setValue(""),u.clearHistory(),a._addBulk(l.param(i)),a.addBulkBtn.trigger("click"),e.preventDefault()}),this.rebuildBtn=this.element.find(this.options.rebuildBtn).button({disabled:!0,icons:{primary:"ui-icon-refresh"}}).click(function(e){a._saveTree(),e.preventDefault()}),this.deleteSelBtn=this.element.find(this.options.deleteSelBtn).button({disabled:!0,icons:{primary:"ui-icon-trash"}}).click(function(e){a.dialogID=a.options.dialogConfirm,l(a.dialogID).dialog({buttons:t}).dialog("open"),e.preventDefault()}),this.saveBtn=this.element.find(this.options.saveBtn).button({disabled:!0,icons:{primary:"ui-icon-check"}}).click(function(e){!0===a.itemsChanged&&a._saveTree(),e.preventDefault()}),this.addBtnOffset=this.addBtn.offset(),this.noItems=this.element.find(this.options.noItems),this.editForm=l(this.options.editForm),p.twig({id:"item_template",data:this.element.find(this.options.itemTemplate).html()}),u=CodeMirror.fromTextArea(l(this.options.addBulkList).get(0),{theme:"monokai",lineNumbers:!0,lineWrapping:!1,autoRefresh:!0,styleActiveLine:!0,fixedGutter:!0,coverGutterNextToScrollbar:!1,indentWithTabs:!0,indentUnit:4}),this.getItems()},addItem:function(){this._saveItem("add_item",{})},updateItem:function(e,t){this._saveItem("update_item",e,t)},getItems:function(){var t=this;l.getJSON(this.options.ajaxUrl+"load_items",function(e){t.nestedList.empty(),t._resetActions(),e.items!==h&&0<e.items.length&&(t._showActions(),t._addToTree(e.items))})},getCodeMirrorInstance:function(){return u},showMessage:function(e){e&&(this.msgObj.text(e),this.msgObj.fadeIn().delay(3e3).fadeOut())},_addBulk:function(e){var t=this;l.post(this.options.ajaxUrl+"add_bulk",e,function(e){e.error?t.showMessage(e.error):(t._showActions(),t._addToTree(e.items))},"json")},_addToTree:function(e,t){if(0<e.length){var i={},s=e.shift();if(s[this.options.fields.itemTitle]=s[this.options.fields.itemTitle]||c.changeMe,0<s[this.options.fields.parentId]){var n=l("#item-"+s[this.options.fields.parentId]);0===n.children(this.options.listType).length?(i=l("<"+this.options.listType+">"+this._renderItem(s)+"</"+this.options.listType+">").hide()).appendTo(n):(i=l(this._renderItem(s)).hide()).appendTo(n.children(this.options.listType))}else(i=l(this._renderItem(s)).hide()).appendTo(this.nestedList);var o=this;i.effect("slide",{direction:"right",mode:"show"},this.options.loadSpeed,function(){o._addToTree(e,t)})}t!==h&&t.apply(this,[e]),this._trigger("loaded",null,{items:e})},_checkRequired:function(){l(this.dialogID+" .error").remove();var e=!0;return l(this.dialogID+" .required").each(function(){l(this).val()||(l('<div class="error">'+c.required+"</div>").insertAfter(this),e=!1)}),e},_getItemId:function(e){return e.attr("id").substring(5)},_getOptions:function(e,n,o){var d=this;return e.children("li").each(function(e,t){var i=l(t),s='<option value="'+d._getItemId(i)+'">'+(n+"&#x251c;&#x2500; "+i.find(".editable:first").text())+"</option>";o+=d._getOptions(i.children("ol"),"&nbsp;&nbsp;&nbsp;&nbsp;"+n,s)}),o},_makeEditable:function(e){!0!==this.editing?(this.editing=!0,this.editorVal=e.text()!==c.changeMe?e.text():"",e.replaceWith('<form id="inline-form"><input type="text" id="inline-edit" value="'+this.editorVal+'" /></form>'),this.editor=l("#inline-edit").data("field",e.data("field")).focus().select()):this.editor.trigger("blur")},_populateForm:function(e,t){var i=this;return l.get(this.options.ajaxUrl+"load_item?"+this.options.fields.itemId+"="+e,function(e){i.showMessage(e.message),i.editForm.populate(e),t(i.dialogID)},"json"),{}},_processEditable:function(e){if(!1!==this.editing){var t=this._getItemId(l(e).parentsUntil("li").parent()),i=l(e).data("field"),s=l(e).val(),n={};return t&&i&&s&&s!==this.editorVal?(n[i]=s,n.field=i,this._saveItem("update_item",n,t,i)):this._undoEditable(this.editorVal?this.editorVal:c.changeMe),!1}},_resetActions:function(e){var t="initial";e||(this.noItems.show(),t="none"),this.itemsChanged=!1,this.addBulkBtn.parent().next().slideUp(),this.selectAllObj.prop("checked",!1).parent().css("display",t),this.deleteSelBtn.button("disable").css("display",t),this.saveBtn.button("disable").css("display",t),this.rebuildBtn.css("display",t)},_saveItem:function(i,e,t,s){var n=this;l.post(this.options.ajaxUrl+i+(t?"?"+this.options.fields.itemId+"="+t:""),e,function(t){if(t.error)n.showMessage(t.error),n.editing&&n._undoEditable(n.editorVal);else switch(i){case"add_item":n._addToTree([t],function(){var e=l("#item-"+t[n.options.fields.itemId]);n._showActions(),n._scrollTo(e,n.addBtnOffset.top,function(){n.options.dialogEdit.length||e.find(".editable").trigger("click")})});break;case"update_item":n.editing?n._undoEditable(t[s]):n._refreshItem(t);break;case"save_item":var e=n._refreshItem(t);n._trigger("updated",null,e)}},"json")},_saveTree:function(){var e=l(this.options.nestedList).find("li").length?this.nestedList.nestedSortable("toArray"):[];this._saveItem("save_tree",{tree:e}),this._resetActions(e.length)},_scrollTo:function(e,t,i){var s=e.offset().top-t;this.nestedList.animate({scrollTop:s},1e3,i)},_showActions:function(){this.noItems.hide(),this.nestedList.show(),this.selectAllObj.parent().show(),this.deleteSelBtn.show(),this.saveBtn.show(),this.rebuildBtn.button("enable").show()},_removeNode:function(e){var t=e.parent(this.options.listType).not(this.options.nestedList);e.siblings().length||!t.length?e.remove():t.remove()},_renderItem:function(e){return p.twig({ref:"item_template"}).render(e)},_refreshItem:function(e){var t=l(this._renderItem(e)).children();return l("#item-"+e[this.options.fields.itemId]).children(":first").replaceWith(t)},_undoEditable:function(e){this.editorVal="",this.editing=!1,this.editor.parent().replaceWith('<span class="editable" data-field="'+this.editor.data("field")+'">'+e+"</span>")},_submitForm:function(e){var t=e?"save_item":"add_item";this._saveItem(t,this.editForm.serializeArray(),e)}})}(jQuery,window,document);
//# sourceMappingURL=builder.min.js.map
