!function($,window,document,undefined){"use strict";var editorVal="",inactiveBlockClass="sm-inactive",editing=!1,updated=!1,dialogEditOpened=!1,blockPositions={},emptyPositionsObj={},template={},origin={},inlineForm={},dialogConfirm={},dialogEdit={},dialogCopy={},cButtons={},dButtons={},eButtons={},lButtons={},blockObj={},blockData={editable:" editable",block:{}},body={},msgObj={},saveBtn={},lang={},config={},actions={},editMode=!1,phpbb={},tinymce={},Twig={},getPOJO=function(t){var e={};return $.each(t,function(){e[this.name]?(e[this.name].push||(e[this.name]=[e[this.name]]),e[this.name].push(this.value||"")):e[this.name]=this.value||""}),e},fixPaths=function(t){return t.replace(new RegExp("(?:href|src)=(?:\"|')((?:./)?(?:../)+)(?:.*?)(?:\"|')","gmi"),function(t,e){return t.replace(e,config.webRootPath)})},removeGrid=function(t){t.removeClass(function(){var t=this.className.match(/grid__col+(\S+)?/gi);return t?t.join(" "):""})},sortHorizontal=function(t){var e=t.length,o=t.parent().data("columns")!==undefined?t.parent().data("columns")<=5?t.parent().data("columns"):5:3,i=e%o,n=e-i;if(e<=o)o=e;else if(t.parent().hasClass("equal")){if(0<i&&3<o)for(var a=1;a<i;a++)if(e%(o-a)==0){o-=a;break}n=e,i=0}if(removeGrid(t),0<n&&t.slice(0,n).addClass("grid__col grid__col--1-of-"+o+" grid__col--m-1-of-"+o),i){var l=1;i<2&&(i=l=5),t.slice(n,e).addClass("grid__col grid__col--"+l+"-of-"+i+" grid__col--m-"+l+"-of-"+i)}},showAllPositions=function(){blockPositions.addClass("show-position"),emptyPositionsObj.removeClass("empty-position").siblings(".grid__col").removeClass("lastUnit"),body.trigger("blitze_sitemaker_showAllBlockPositions",[blockPositions,emptyPositionsObj])},hideEmptyPositions=function(){blockPositions.removeClass("show-position"),emptyPositionsObj=$('.block-position:not(:has(".block"))').addClass("empty-position").each(function(){$(this).siblings(".grid__col").last().addClass("lastUnit")}),body.trigger("blitze_sitemaker_hideEmptyBlockPositions",[blockPositions,emptyPositionsObj])},makeEditable=function(t){!0!==editing?(editing=!0,editorVal=t.removeClass("editable").text(),inlineForm.show().appendTo(t.text("")).children(":input").val(editorVal).focus().select().end()):inlineForm.children(":input").trigger("blur")},undoEditable=function(t){var e=inlineForm.parent();editing=!1,editorVal="",e.addClass("editable").text(t),inlineForm.hide().appendTo($("body"))},renderBlock=function(blockObj,blockData){var id="block-editor-"+blockData.block.id,editor=tinymce.get(id);editor&&tinymce.EditorManager.remove(editor),blockData.block.content=fixPaths(blockData.block.content),!1!==body.trigger("blitze_sitemaker_renderBlock_before",[blockData.block,blockObj]).data("renderBlock")&&blockObj.html(template.render(blockData)),"blitze.sitemaker.block.custom"===blockData.block.name&&(blockObj.find("#"+id).length?tinymce.EditorManager.execCommand("mceAddEditor",!1,id):-1<blockData.block.content.indexOf("script")&&eval(blockObj.find(".sm-block-content").html())),body.trigger("blitze_sitemaker_renderBlock_after",[blockData.block,blockObj])},saveLayout=function(){var n={};$(".block-position").each(function(){var o=0,i=$(this).attr("id");$(this).find(".block").each(function(){var t=$(this).attr("id");if(i!==undefined&&t!==undefined){var e=t.substring(6);n[e]={position:i.substring(4),weight:o},o++}})}),$.post(actions.save_blocks,{route:config.route,blocks:n},function(){saveBtn.button("disable"),updated=!1})},addBlock=function(t,e,o){$(o).removeAttr("role aria-disabled data-block class style").addClass("block").html('<div class="ui-state-highlight sm-block-spacing sortable" style="padding: 5px"><i class="fa fa-spinner fa-2x fa-spin"></i> '+lang.ajaxLoading+"</div>");var i={block:$.trim(e),weight:o.parent().find(".block").index(o),route:config.route,ext:config.ext,position:t};$.getJSON(actions.add_block,i,function(t){if(updated=!1,""!==t.id){var e=$(o).attr("id","block-"+t.id);renderBlock(e,{block:t}),e.children().not(".block-controls").show("scale",{percent:100},1e3),updated&&saveLayout()}else $(o).remove()})},getEditForm=function(t){$.getJSON(actions.edit_block,{id:t.attr("id").substring(6)},function(t){(blockData.block=t).form&&(dialogEdit.html(t.form),dialogEdit.find("#block-settings").tabs(),dialogEdit.find("select[data-togglable-settings]").each(function(){var t=$(this);t.change(function(){phpbb.toggleSelectSettings(t)}),phpbb.toggleSelectSettings(t)}),dialogEdit.dialog({buttons:eButtons}).dialog("option","title",lang.edit+" - "+t.title.replace(/(<([^>]+)>)/gi,"")).dialog("open"))})},getCustomClasses=function(){return dialogEdit.find("#block_class").text().trim()},saveForm=function(t){var e=getPOJO($("#edit_form").serializeArray()),o=dialogEdit.dialog("widget").find("#update-similar:checked").length;$.extend(e,{id:t.attr("id").substring(6),route:config.route,similar:o,class:getCustomClasses()}),e["config[source]"]&&(e["config[source]"]=encodeURI(e["config[source]"])),dialogEdit.dialog("close"),$.post(actions.save_block,e,function(t){t.list&&$.each(t.list,function(t,e){renderBlock($("#block-"+e.id),{block:e})})})},updateBlock=function(t){if(t.id===undefined)return!1;t.route=config.route,$.post(actions.update_block,t,function(t){!0===editing&&undoEditable(t.title)},"json")},customBlockAction=function(t){t.id!==undefined&&$.post(actions.handle_custom_action,t,function(t){if(t.id){var e="block-editor-"+t.id,o=fixPaths(t.content),i=$("#block-"+t.id+" > .sm-block-container"),n=$("#"+e).attr("data-raw",o);tinymce.get(e).setContent(o||lang.placeholder),t.content&&n.data("active")?i.removeClass(inactiveBlockClass):i.addClass(inactiveBlockClass)}})},setDefaultLayout=function(t){$.post(actions.set_default_route,{route:!0===t?config.route:""})},setStartPage=function(t){$.post(actions.set_startpage,$.param(t))},setRoutePrefs=function(t,e){var o=$.extend(getPOJO(t.serializeArray()),{route:config.route,ext:config.ext});$.post(actions.set_route_prefs,o,function(){blockPositions.removeClass(inactiveBlockClass),e&&hidePositions(e)})},copyBlocks=function(t){var e=$(".block-position"),o=$.extend(getPOJO(t),{route:config.route,ext:config.ext});$.getJSON(actions.copy_route,o,function(t){t.list&&0!==t.list.length&&(showAllPositions(),e.empty(),$.each(t.list,function(t,e){var o=$("#pos-"+t);$.each(e,function(t,e){blockData.block=e,o.append('<div id="block-'+e.id+'" class="unit size1of1 block"></div>'),renderBlock(o.find("#block-"+e.id),blockData)}),o.hasClass("horizontal")&&sortHorizontal(o.find(".block"))}),hideEmptyPositions())})},processInput=function(t){if(!1!==editing){var e=$(t).parentsUntil(".block").parent().attr("id").substring(6),o=$(t).val();return e&&o!==editorVal?updateBlock({id:e,field:"title",title:o}):undoEditable(editorVal),!1}},previewBlock=function(){var t=$.extend(!0,{},blockData),e=dialogEdit.find("#edit_form").serializeArray(),o=getCustomClasses();$.each(e,function(){t.block[this.name]="boolean"==typeof t.block[this.name]?"1"===this.value:this.value}),t.block.class=o?" "+o:"",renderBlock(blockObj,t)},undoPreviewBlock=function(){renderBlock(blockObj,blockData)},initTinyMce=function(){var t={selector:"div.editable-block",inline:!0,image_advtab:!0,hidden_input:!1,noneditable_noneditable_class:"fa",plugins:["advlist autolink lists link image imagetools charmap preview hr anchor pagebreak","visualblocks visualchars code media nonbreaking save table contextmenu directionality","paste textcolor colorpicker textpattern fontawesome noneditable"],toolbar:["undo redo | styleselect | fontsizeselect | bold italic | forecolor backcolor | alignleft aligncenter alignright alignjustify","responsivefilemanager image media | fontawesome | bullist numlist outdent indent | hr pagebreak | link | table | removeformat code"],automatic_uploads:!0,images_reuse_filename:!0,images_upload_base_path:config.webRootPath+"images/sitemaker_uploads/source/",images_upload_url:config.uploadUrl,valid_elements:"*[*]",end_container_on_empty_block:!0,setup:function(i){var e={},o=!0,n="";i.on("init",function(){0===i.getContent().length&&i.setContent(lang.placeholder)}),i.on("focus",function(){var t=i.id.substring(13);e=$("#block-"+t+" > .sm-block-container"),o=e.hasClass(inactiveBlockClass),n=$("#"+i.id).data("raw"),i.setContent(n)}),i.on("keyUp",function(){o&&i.getContent().length?(o=!1,e.removeClass(inactiveBlockClass)):o||i.getContent().length||(o=!0,e.addClass(inactiveBlockClass))}),i.on("blur",function(){tinymce.activeEditor.uploadImages(function(){var t=i.getContent({format:"raw"}).replace('<p><br data-mce-bogus="1"></p>',""),e=i.getContent();if(t!==n&&t!==lang.placeholder){e.length||(t="",i.setContent(lang.placeholder));var o=$("#"+i.id).data("raw",t).data();o.id=i.id.substring(13),o.content=t,customBlockAction(o)}else e||i.setContent(lang.placeholder)})})}};if(config.filemanager){t.plugins.push("responsivefilemanager");var e=config.scriptPath+"ResponsiveFilemanager/filemanager/";$.extend(!0,t,{external_filemanager_path:e,external_plugins:{filemanager:e+"plugin.min.js"},filemanager_access_key:config.RFAccessKey,filemanager_title:lang.fileManager})}tinymce.init(t)},showMessage=function(t){t&&(msgObj.html(t),msgObj.fadeIn().delay(3e3).fadeOut())},hidePositions=function(t){$.each(t,function(t,e){$("#pos-"+e).addClass(inactiveBlockClass)})},showCurrentState=function(t,e){t?showMessage('<span><i class="fa fa-info-circle fa-blue fa-lg"></i> '+lang.hidingBlocks+"</span>"):e.length&&(showMessage('<span><i class="fa fa-info-circle fa-blue fa-lg"></i> '+lang.hidingPos+": <strong>"+e.join(", ")+"</strong></span>"),hidePositions(e))};$(document).ready(function(){editMode=window.editMode||!1,lang=window.lang||{},phpbb=window.phpbb||{},tinymce=window.tinymce||{},Twig=window.Twig||{},actions=window.actions||{},config=window.config||{boardUrl:"",route:"",ext:"",style:"",uploadUrl:""};var a="",l={},e={},o={},i=!1,n=$("#admin-bar").show().find("#admin-control").click(function(){if(editMode)return $(this).toggleClass("admin-bar-toggler").prev().toggle(),body.toggleClass("push-down"),!1}).find("i");if(editMode){inlineForm=$('<form class="inline-form"><input type="text" class="inline-edit" value="" /></form>').hide().appendTo($("body")),msgObj=$("#ajax-message"),emptyPositionsObj=$('.block-position:not(:has(".block"))').addClass("empty-position"),template=Twig.twig({data:$.trim($("#block-template-container").html())}),$("#add-block-panel").find(".sitemaker-block").draggable({addClasses:!1,iframeFix:!0,opacity:.7,helper:"clone",appendTo:"body",revert:"invalid",connectToSortable:".block-position",start:function(t,e){$(e.helper).addClass("dragging"),showAllPositions(),blockPositions.sortable("refresh"),l.trigger("click")},stop:function(){window.setTimeout(function(){!1===updated&&hideEmptyPositions()},600)}}),e=$("#ex_positions");var t={revert:!0,placeholder:"ui-state-highlight grid__col sm-block-spacing block sortable placeholder",connectWith:".block-position",cancel:".editable-block, .inline-edit",items:".block",tolerance:"pointer",cursor:"move",cursorAt:{top:-10,left:-10},start:function(t,e){origin=$(e.item).addClass("dragging").parent(".horizontal"),showAllPositions(),$(".block-position").sortable("refresh")},over:function(t,e){o=e.placeholder.parent(".horizontal").children(".block").addClass("sortable")},out:function(){!1===$.isEmptyObject(o)&&o.removeClass("sortable")},update:function(t,e){if(updated=!0,$(e.item).attr("id")===undefined){var o=$(this).attr("id").substring(4),i=$(e.item).attr("data-block"),n=$(this).find('div[data-block="'+i+'"]');addBlock(o,i,n)}else saveBtn.button("enable");var a=$(e.item).removeAttr("style").parent(".horizontal").children(".block"),l=$(e.item);l.parent().removeClass("empty-position"),removeGrid(l),0<a.length&&sortHorizontal(a),origin.attr("id")!==$(e.item).parent(".horizontal").attr("id")&&sortHorizontal(origin.find(".block").removeClass("sortable"))},stop:function(t,e){$(e.item).removeClass("dragging sortable").removeAttr("style"),hideEmptyPositions(),body.trigger("blitze_sitemaker_layout_changed")}};blockPositions=$(".block-position").addClass("block-receiver").sortable(t).on("click",".block-title",function(t){t.stopPropagation(),makeEditable($(this))}).on("submit",".inline-form",function(t){t.preventDefault(),$(this).find(".inline-edit").trigger("blur")}).on("focusout",".inline-edit",function(){processInput($(this))}).on("click",".edit-block",function(t){t.preventDefault(),blockObj=$(this).parentsUntil(".block").parent(),getEditForm(blockObj)}).on("click",".delete-block",function(t){t.preventDefault(),blockObj=$(this).parentsUntil(".block").parent(),dialogConfirm.dialog({buttons:dButtons}).dialog("open")}).on("click",".editable-block",function(){var t=$(this).attr("id");tinymce.get(t)||(tinymce.EditorManager.execCommand("mceAddEditor",!1,t),$(this).blur(),setTimeout(function(){tinymce.get(t).focus()},300))}).each(function(){var t=$(this).attr("id").substring(4);0===e.find("option[value="+t+"]").length&&e.append('<option value="'+t+'">'+t+"</option>")}),$("body").on("blitze_sitemaker_layout_changed",function(){blockPositions=$(".block-position").addClass("block-receiver").sortable(t)}),$("#toggle-edit").button(),saveBtn=$("#save-changes").button({disabled:!0}).click(function(t){t.preventDefault(),saveLayout()}),$(".has-dropdown").click(function(t){t.preventDefault(),$(this).parentsUntil("ul").parent().find(".dropped").not($(this)).removeClass("dropped").next().hide(),(l=$(this).toggleClass("dropped")).next().toggle()}),$("#admin-options").show(100,function(){var t=e.val();t&&showCurrentState(i,t),body=$("body").addClass("push-down")});var s=$("#style-options");1<s.find("option").length&&s.show(),$.ajaxSetup({beforeSend:function(t,e){n.addClass("fa-spinner fa-green fa-spin fa-lg fa-pulse"),e.url+=(e.url.indexOf("?")<0?"?":"&")+"style="+config.style},complete:function(t){n.delay(2e3).removeClass("fa-spinner fa-green fa-spin fa-lg fa-pulse"),t.responseJSON&&t.responseJSON.message&&showMessage(t.responseJSON.message)},error:function(t){showMessage(t.responseJSON&&t.responseJSON.message?t.responseJSON.message:lang.ajaxError)}}),eButtons[lang.edit]=function(){saveForm(blockObj)},eButtons[lang.cancel]=function(){$(this).dialog("close")},dButtons[lang.remove]=function(){var t=blockObj.parent(".horizontal");blockObj.remove(),t.find(".ui-effects-placeholder").remove();var e=t.find(".block");0<e.length&&sortHorizontal(e),hideEmptyPositions(),saveBtn.button("enable"),$(this).dialog("close")};var c={autoOpen:!(dButtons[lang.cancel]=function(){$(this).dialog("close")}),modal:!0,width:"auto",show:"slide",hide:"slide"};dialogConfirm=$("#dialog-confirm").dialog(c),lButtons[lang.deleteAll]=function(){$(this).dialog("close"),$(".block-position").empty(),hideEmptyPositions(),saveBtn.button("enable"),updated=!0},lButtons[lang.cancel]=function(){$(this).dialog("close")};var r=$("#dialog-delete-all").dialog(c),d=$("#delete-blocks").button().click(function(t){t.preventDefault(),r.dialog({buttons:lButtons}).dialog("open")});cButtons[lang.copy]=function(){$(this).dialog("close"),copyBlocks(a),d.parent().show()},cButtons[lang.cancel]=function(){$(this).dialog("close")},dialogCopy=$("#dialog-copy").dialog(c),$("#copy-form").find(".layout-action").button().click(function(t){t.preventDefault();var e=(a=$(this).parent().parent().serializeArray())[0].value,o=a[1].value,i=$(this).data("action");if(""===e||e===config.route&&o===config.style)return!1;if("copy"===i)l.trigger("click"),dialogCopy.dialog({buttons:cButtons}).dialog("open");else{var n=config.boardUrl+"/";n+=config.modReWrite?e.replace("app.php/",""):e,n+=(0<=n.indexOf("?")?"&":"?")+"style="+o,window.location.href=n}}),c.open=function(){if(!1===dialogEditOpened){var t=$(this).dialog("widget").find(".ui-dialog-buttonpane");dialogEditOpened=!0,$('<label class="dialog-check-button"><input id="update-similar" type="checkbox" /> '+lang.updateSimilar+"</label>").prependTo(t)}},c.beforeClose=function(){undoPreviewBlock()},dialogEdit=$("#dialog-edit").dialog(c).on("click",".block-class-actions",function(t){t.preventDefault();var e=$(this).data("action"),o=dialogEdit.find("#block_class");switch(e){case"clear":o.text("").change();break;case"toggle":var i=$(this).attr("href");dialogEdit.find(i).slideToggle();break;case"undo":case"redo":o.focus(),document.execCommand(e,!1,null),o.change()}}).on("click",".class-cat",function(t){var e=$(this).attr("href"),o=$("#classes-scroller");o.animate({scrollTop:o.scrollTop()+$(e).position().top},1e3),t.preventDefault()}).on("click",".transform",function(t){var e=dialogEdit.find("#block_class");e.focus(),document.execCommand("insertText",!1,$(this).text()+" "),e.change(),t.preventDefault()}).on("change",".block-preview",function(){previewBlock()}),$(".default-layout").button().click(function(t){var e=$(this).data("set");setDefaultLayout(e),t.preventDefault(),!0===e?($(this).parent().hide().next().hide().next().show(),d.parent().hide()):($(this).parent().hide().prev().hide().prev().show(),d.parent().show())}),$(".sm-startpage").button().click(function(t){t.preventDefault();var e={};"set-startpage"===$(this).attr("id")?($(this).parent().hide().next().show(),e={controller:$(this).data("controller"),method:$(this).data("method"),params:$(this).data("params")}):$(this).parent().hide().prev().show(),setStartPage(e)}),i=$("#route-settings").submit(function(t){setRoutePrefs($(this),e.val()),t.preventDefault()}).find("#hide_blocks").is(":checked"),window.onbeforeunload=function(t){if(!0===updated)return(t=t||window.event)&&(t.returnValue=lang.leaveConfirm),lang.leaveConfirm},$(".sitemaker").iconPicker({selector:".block-icon",onSelect:function(t,e){var o=t.parentsUntil(".block").parent().attr("id").substring(6);updateBlock({id:o,icon:e})}}),initTinyMce()}})}(jQuery,window,document);
//# sourceMappingURL=manager.min.js.map
